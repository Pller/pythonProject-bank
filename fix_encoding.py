# fix_encoding.py
import re

print("Исправляем кодировку utils.py...")

with open('src/utils.py', 'r', encoding='utf-8') as f:
    content = f.read()

# Заменяем кракозябры на русский текст
replacements = {
    'Р—Р°РіСЂСѓР·РєР° РїРµСЂРµРјРµРЅРЅС‹С… РѕРєСЂСѓР¶РµРЅРёСЏ': 'Загрузка переменных окружения',
    'Р—Р°РіСЂСѓР¶Р°РµС‚ С‚СЂР°РЅР·Р°РєС†РёРё РёР· Excel С„Р°Р№Р»Р°.': 'Загружает транзакции из Excel файла.',
    'Args:': 'Аргументы:',
    'filepath: РџСѓС‚СЊ Рє Excel С„Р°Р№Р»Сѓ': 'filepath: Путь к Excel файлу',
    'Returns:': 'Возвращает:',
    'РЎРїРёСЃРѕРє СЃР»РѕРІР°СЂРµР№ СЃ С‚СЂР°РЅР·Р°РєС†РёСЏРјРё': 'Список словарей с транзакциями',
    'Р¤Р°Р№Р» {filepath} РЅРµ РЅР°Р№РґРµРЅ. Р’РѕР·РІСЂР°С‰Р°СЋ РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє.': f'Файл {{filepath}} не найден. Возвращаю пустой список.',
    'РЈСЃРїРµС€РЅРѕ РїСЂРѕС‡РёС‚Р°РЅРѕ {len(df)} С‚СЂР°РЅР·Р°РєС†РёР№ РёР· {filepath}': f'Успешно прочитано {{len(df)}} транзакций из {{filepath}}',
    'РљРѕР»РѕРЅРєРё РІ РґР°РЅРЅС‹С…: {list(df.columns)}': f'Колонки в данных: {{list(df.columns)}}',
    'РљРѕРЅРІРµСЂС‚РёСЂСѓРµРј РґР°С‚С‹ РµСЃР»Рё РѕРЅРё РµСЃС‚СЊ': 'Конвертируем даты если они есть',
    'date_columns = [col for col in df.columns if \'РґР°С‚Р°\' in col.lower() or \'date\' in col.lower()]': 'date_columns = [col for col in df.columns if \'дата\' in col.lower() or \'date\' in col.lower()]',
    'РћС€РёР±РєР° Р·Р°РіСЂСѓР·РєРё РґР°РЅРЅС‹С… РёР· {filepath}: {e}': f'Ошибка загрузки данных из {{filepath}}: {{e}}',
    'Р—Р°РіСЂСѓР·Р°РµС‚ РЅР°СЃС‚СЂРѕР№РєРё РёР· С„Р°Р№Р»Р°.': 'Загружает настройки из файла.',
    'settings_file: РџСѓС‚СЊ Рє С„Р°Р№Р»Сѓ СЃ РЅР°СЃС‚СЂРѕР№РєР°РјРё': 'settings_file: Путь к файлу с настройками',
    'РЎР»РѕРІР°СЂСЊ СЃ РЅР°СЃС‚СЂРѕР№РєР°РјРё': 'Словарь с настройками',
    'Р”РѕР±Р°РІР»СЏРµРј РїРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ': 'Добавляем переменные окружения',
    'Р—Р°РіСЂСѓР¶РµРЅРѕ {len(settings)} РЅР°СЃС‚СЂРѕРµРє': f'Загружено {{len(settings)}} настроек',
    'РћС€РёР±РєР° Р·Р°РіСЂСѓР·РєРё РЅР°СЃС‚СЂРѕРµРє: {e}': f'Ошибка загрузки настроек: {{e}}',
    'РЎРѕС…СЂР°РЅСЏРµС‚ РѕС‚С‡РµС‚ РІ JSON С„Р°Р№Р».': 'Сохраняет отчет в JSON файл.',
    'report_data: Р”Р°РЅРЅС‹Рµ РѕС‚С‡РµС‚Р°': 'report_data: Данные отчета',
    'filename_prefix: РџСЂРµС„РёРєСЃ РёРјРµРЅРё С„Р°Р№Р»Р°': 'filename_prefix: Префикс имени файла',
    'РџСѓС‚СЊ Рє СЃРѕС…СЂР°РЅРµРЅРЅРѕРјСѓ С„Р°Р№Р»Сѓ': 'Путь к сохраненному файлу',
    'РћС‚С‡РµС‚ СЃРѕС…СЂР°РЅРµРЅ РІ С„Р°Р№Р»: {filename}': f'Отчет сохранен в файл: {{filename}}',
    'РћС€РёР±РєР° СЃРѕС…СЂР°РЅРµРЅРёСЏ РѕС‚С‡РµС‚Р°: {e}': f'Ошибка сохранения отчета: {{e}}',
    'РџРѕР»СѓС‡Р°РµС‚ РєСѓСЂСЃС‹ РІР°Р»СЋС‚ (Р·Р°РіР»СѓС€РєР°).': 'Получает курсы валют (заглушка).',
    'currency_codes: РЎРїРёСЃРѕРє РєРѕРґРѕРІ РІР°Р»СЋС‚': 'currency_codes: Список кодов валют',
    'РЎР»РѕРІР°СЂСЊ СЃ РєСѓСЂСЃР°РјРё РІР°Р»СЋС‚': 'Словарь с курсами валют',
    'Р—Р°РіР»СѓС€РєР° РґР»СЏ РґРµРјРѕРЅСЃС‚СЂР°С†РёРё': 'Заглушка для демонстрации',
    'Р’ СЂРµР°Р»СЊРЅРѕРј РїСЂРёР»РѕР¶РµРЅРёРё Р·РґРµСЃСЊ Р±СѓРґРµС‚ API Р·Р°РїСЂРѕСЃ': 'В реальном приложении здесь будет API запрос',
    'РџРѕР»СѓС‡РµРЅС‹ РєСѓСЂСЃС‹ РґР»СЏ {len(rates)} РІР°Р»СЋС‚': f'Получены курсы для {{len(rates)}} валют',
    'РћС€РёР±РєР° РїРѕР»СѓС‡РµРЅРёСЏ РєСѓСЂСЃРѕРІ РІР°Р»СЋС‚: {e}': f'Ошибка получения курсов валют: {{e}}',
    'РџРѕР»СѓС‡Р°РµС‚ С†РµРЅС‹ Р°РєС†РёР№ (Р·Р°РіР»СѓС€РєР°).': 'Получает цены акций (заглушка).',
    'stock_symbols: РЎРїРёСЃРѕРє СЃРёРјРІРѕР»РѕРІ Р°РєС†РёР№': 'stock_symbols: Список символов акций',
    'РЎР»РѕРІР°СЂСЊ СЃ С†РµРЅР°РјРё Р°РєС†РёР№': 'Словарь с ценами акций',
    'РџРѕР»СѓС‡РµРЅС‹ С†РµРЅС‹ РґР»СЏ {len(prices)} Р°РєС†РёР№': f'Получены цены для {{len(prices)}} акций',
    'РћС€РёР±РєР° РїРѕР»СѓС‡РµРЅРёСЏ С†РµРЅ Р°РєС†РёР№: {e}': f'Ошибка получения цен акций: {{e}}',
    'Р¤РѕСЂРјР°С‚РёСЂСѓРµС‚ СЃСѓРјРјСѓ РґР»СЏ РІС‹РІРѕРґР°.': 'Форматирует сумму для вывода.',
    'amount: РЎСѓРјРјР°': 'amount: Сумма',
    'currency: Р’Р°Р»СЋС‚Р°': 'currency: Валюта',
    'РћС‚С„РѕСЂРјР°С‚РёСЂРѕРІР°РЅРЅР°СЏ СЃС‚СЂРѕРєР°': 'Отформатированная строка',
    'Р¤РёР»СЊС‚СЂСѓРµС‚ С‚СЂР°РЅР·Р°РєС†РёРё РїРѕ РґРёР°РїР°Р·РѕРЅСѓ РґР°С‚.': 'Фильтрует транзакции по диапазону дат.',
    'transactions: РЎРїРёСЃРѕРє С‚СЂР°РЅР·Р°РєС†РёР№': 'transactions: Список транзакций',
    'start_date: РќР°С‡Р°Р»СЊРЅР°СЏ РґР°С‚Р° (YYYY-MM-DD)': 'start_date: Начальная дата (YYYY-MM-DD)',
    'end_date: РљРѕРЅРµС‡РЅР°СЏ РґР°С‚Р° (YYYY-MM-DD)': 'end_date: Конечная дата (YYYY-MM-DD)',
    'date_column: РќР°Р·РІР°РЅРёРµ РєРѕР»РѕРЅРєРё СЃ РґР°С‚РѕР№': 'date_column: Название колонки с датой',
    'РћС‚С„РёР»СЊС‚СЂРѕРІР°РЅРЅС‹Р№ СЃРїРёСЃРѕРє С‚СЂР°РЅР·Р°РєС†РёР№': 'Отфильтрованный список транзакций',
    'РћС‚С„РёР»СЊС‚СЂРѕРІР°РЅРѕ {len(filtered)} РёР· {len(transactions)} С‚СЂР°РЅР·Р°РєС†РёР№': f'Отфильтровано {{len(filtered)}} из {{len(transactions)}} транзакций',
    'РћС€РёР±РєР° С„РёР»СЊС‚СЂР°С†РёРё РїРѕ РґР°С‚Рµ: {e}': f'Ошибка фильтрации по дате: {{e}}',
    'Р Р°СЃСЃС‡РёС‚С‹РІР°РµС‚ Р±Р°Р·РѕРІСѓСЋ СЃС‚Р°С‚РёСЃС‚РёРєСѓ РїРѕ С‚СЂР°РЅР·Р°РєС†РёСЏРј.': 'Рассчитывает базовую статистику по транзакциям.',
    'РЎР»РѕРІР°СЂСЊ СЃРѕ СЃС‚Р°С‚РёСЃС‚РёРєРѕР№': 'Словарь со статистикой',
    'РћС€РёР±РєР° СЂР°СЃС‡РµС‚Р° СЃС‚Р°С‚РёСЃС‚РёРєРё: {e}': f'Ошибка расчета статистики: {{e}}',
    'Р§РёС‚Р°РµС‚ Excel С„Р°Р№Р» Рё РІРѕР·РІСЂР°С‰Р°РµС‚ DataFrame.': 'Читает Excel файл и возвращает DataFrame.',
    'file_path: РџСѓС‚СЊ Рє Excel С„Р°Р№Р»Сѓ': 'file_path: Путь к Excel файлу',
    'DataFrame СЃ РґР°РЅРЅС‹РјРё': 'DataFrame с данными',
    'Р¤Р°Р№Р» {file_path} РЅРµ РЅР°Р№РґРµРЅ': f'Файл {{file_path}} не найден',
    'РџСЂРѕС‡РёС‚Р°РЅ С„Р°Р№Р» {file_path}. РЎС‚СЂРѕРє: {len(df)}, РљРѕР»РѕРЅРѕРє: {len(df.columns)}': f'Прочитан файл {{file_path}}. Строк: {{len(df)}}, Колонок: {{len(df.columns)}}',
    'РћС€РёР±РєР° С‡С‚РµРЅРёСЏ С„Р°Р№Р»Р° {file_path}: {e}': f'Ошибка чтения файла {{file_path}}: {{e}}',
}

# Заменяем кракозябры
for old, new in replacements.items():
    content = content.replace(old, new)

# Теперь добавим недостающие функции
additional_functions = '''

def load_transactions(file_path: str | Path) -> pd.DataFrame:
    """Загружает транзакции из Excel-файла."""
    try:
        path = Path(file_path).resolve()

        if os.getenv("TESTING") != "True" and not path.exists():
            raise FileNotFoundError(f"Файл {path} не найден")

        df = pd.read_excel(path)
        logger.info("Успешно загружены транзакции из %s", path)
        return df
    except Exception as e:
        logger.error("Ошибка загрузки транзакций: %s", str(e))
        raise


def get_greeting(time: datetime) -> str:
    """Возвращает приветствие в зависимости от времени суток."""
    hour = time.hour
    if 5 <= hour < 12:
        return "Доброе утро"
    if 12 <= hour < 17:
        return "Добрый день"
    if 17 <= hour < 23:
        return "Добрый вечер"
    return "Доброй ночи"


def get_currency_rates(currencies: List[str] = None) -> List[Dict[str, Any]]:
    """Получает текущие курсы валют из API."""
    try:
        if os.getenv("TESTING") == "True":
            # Для тестов возвращаем заглушку
            default_currencies = currencies or ["USD", "EUR", "GBP"]
            return [{"currency": c, "rate": 1.0} for c in default_currencies]

        # Здесь должен быть реальный API запрос
        # Пока используем заглушку
        rates = {
            "USD": 90.5,
            "EUR": 98.2,
            "GBP": 114.3,
            "CNY": 12.5,
            "JPY": 0.61,
        }

        if currencies:
            rates = {c: rates.get(c, 0.0) for c in currencies}

        return [
            {
                "currency": currency,
                "rate": rate,
            }
            for currency, rate in rates.items()
        ]

    except Exception as e:
        logger.error(f"Ошибка получения курсов валют: {e}")
        return []


def get_stock_prices(stocks: List[str] = None) -> List[Dict[str, Any]]:
    """Получает текущие цены акций из API."""
    try:
        if os.getenv("TESTING") == "True":
            # Для тестов возвращаем заглушку
            default_stocks = stocks or ["AAPL", "GOOGL", "MSFT", "TSLA", "AMZN"]
            return [{"stock": s, "price": 100.0} for s in default_stocks]

        # Здесь должен быть реальный API запрос
        # Пока используем заглушку
        prices = {
            "AAPL": 185.2,
            "GOOGL": 142.5,
            "MSFT": 374.5,
            "TSLA": 240.1,
            "AMZN": 154.9,
        }

        if stocks:
            prices = {symbol: prices.get(symbol, 0) for symbol in stocks}

        return [
            {
                "stock": stock,
                "price": price,
            }
            for stock, price in prices.items()
        ]

    except Exception as e:
        logger.error(f"Ошибка получения цен акций: {e}")
        return []
'''

# Добавляем функции в конец файла, но перед последней строкой если есть
if 'def analyze_expenses' in content:
    # Находим позицию перед analyze_expenses
    pos = content.find('def analyze_expenses')
    content = content[:pos] + additional_functions + '\n\n' + content[pos:]
else:
    # Иначе добавляем в конец
    content += additional_functions

# Сохраняем исправленный файл
with open('src/utils.py', 'w', encoding='utf-8') as f:
    f.write(content)

print("✅ utils.py исправлен (кодировка и добавлены функции)")
